<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <title>Switchcore CRM</title>
  <style>
    body { font-family: 'Arial', sans-serif; max-width: 800px; margin: 0 auto; padding: 20px; color: #333; }
    .client-card { background: #fff; padding: 25px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); margin-bottom: 30px; }
    .field { margin-bottom: 15px; padding-bottom: 15px; border-bottom: 1px solid #eee; }
    .label { font-weight: bold; display: inline-block; width: 150px; color: #555; }
    .value { color: #222; }
    textarea { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 4px; font-family: inherit; }
    button { background: #4285f4; color: white; border: none; padding: 10px 15px; border-radius: 4px; cursor: pointer; }
    button:hover { background: #3367d6; }
    #message { padding: 15px; margin: 20px 0; border-radius: 4px; display: none; }
    .error { background: #ffebee; color: #c62828; border-left: 4px solid #c62828; }
    .success { background: #e8f5e9; color: #2e7d32; border-left: 4px solid #2e7d32; }
    h1 { color: #4285f4; margin-bottom: 25px; }
  </style>
</head>
<body>
  <h1>Switchcore CRM Dashboard</h1>
  
  <div class="client-card">
    <div class="field">
      <span class="label">Client ID:</span>
      <span class="value" id="clientId">Loading...</span>
    </div>
    <div class="field">
      <span class="label">Name:</span>
      <span class="value" id="clientName"></span>
    </div>
    <div class="field">
      <span class="label">Company:</span>
      <span class="value" id="companyName"></span>
    </div>
    <div class="field">
      <span class="label">Email:</span>
      <span class="value" id="clientEmail"></span>
    </div>
    <div class="field">
      <span class="label">Stage:</span>
      <span class="value" id="clientStage"></span>
    </div>
    <div class="field">
      <span class="label">Tags:</span>
      <span class="value" id="clientTags"></span>
    </div>
    
    <h3>Client Notes</h3>
    <textarea id="clientNotes" rows="5" placeholder="Enter client notes here..."></textarea>
    <button onclick="saveNotes()">Save Notes</button>
    
    <div id="message"></div>
  </div>

  <script>
    document.addEventListener('DOMContentLoaded', function() {
      const urlParams = new URLSearchParams(window.location.search);
      const clientId = urlParams.get('clientId') || 'Z'; // Default to 'Z' for testing
      document.getElementById('clientId').textContent = clientId;
      loadClientData(clientId);
    });

    function loadClientData(clientId) {
      google.script.run
        .withSuccessHandler(displayClient)
        .withFailureHandler(showError)
        .getClientData(clientId);
    }

    function displayClient(response) {
      try {
        const data = typeof response === 'string' ? JSON.parse(response) : response;
        
        if(data.error) {
          showError(data.error);
          return;
        }
        
        // Display all available data
        document.getElementById('clientName').textContent = data.clientName || 'Not specified';
        document.getElementById('companyName').textContent = data.companyName || 'Not specified';
        document.getElementById('clientEmail').textContent = data.clientEmail || 'Not specified';
        document.getElementById('clientStage').textContent = data.clientStage || 'Not specified';
        document.getElementById('clientTags').textContent = data.clientTags || 'None';
        document.getElementById('clientNotes').value = data.clientNotes || '';
        
        showMessage('Client data loaded successfully', 'success');
      } catch (e) {
        showError('Error parsing client data: ' + e.message);
      }
    }

    function saveNotes() {
      const clientId = document.getElementById('clientId').textContent;
      const notes = document.getElementById('clientNotes').value;
      
      google.script.run
        .withSuccessHandler(function() {
          showMessage('Notes saved successfully!', 'success');
        })
        .withFailureHandler(showError)
        .updateClientNotes(clientId, notes);
    }

    function showError(message) {
      const msgDiv = document.getElementById('message');
      msgDiv.innerHTML = `<strong>Error:</strong> ${message}`;
      msgDiv.className = 'error';
      msgDiv.style.display = 'block';
    }

    function showMessage(text, type) {
      const msgDiv = document.getElementById('message');
      msgDiv.textContent = text;
      msgDiv.className = type;
      msgDiv.style.display = 'block';
      setTimeout(() => msgDiv.style.display = 'none', 5000);
    }
  </script>
</body>
</html>
